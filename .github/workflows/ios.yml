
name: iOS Build (Clean Project)

run-name: iOS Build • ${{ github.ref_name }} • ${{ github.sha }} • ${{ github.event.head_commit.message || github.event.pull_request.title || 'manual' }}

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    timeout-minutes: 45
    
    steps:
    - uses: actions/checkout@v4

    - name: Compute Artifact Tag
      shell: bash
      run: |
        set -euo pipefail

        EVENT_NAME="${GITHUB_EVENT_NAME}"
        BRANCH_NAME="${GITHUB_REF_NAME}"
        SHA7="${GITHUB_SHA:0:7}"
        TS="$(date -u +%Y%m%d%H%M%S)"

        if [ "${EVENT_NAME}" = "pull_request" ]; then
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
        else
          BASE_SHA="${{ github.event.before }}"
          HEAD_SHA="${GITHUB_SHA}"
        fi

        if [ -z "${BASE_SHA}" ] || [ "${BASE_SHA}" = "0000000000000000000000000000000000000000" ]; then
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            BASE_SHA="$(git rev-parse HEAD~1)"
          else
            BASE_SHA="${GITHUB_SHA}"
          fi
        fi

        PRIMARY_FILE="$(git diff --name-only "${BASE_SHA}" "${HEAD_SHA}" | head -n 1 || true)"
        if [ -z "${PRIMARY_FILE}" ]; then
          PRIMARY_FILE="manual"
        fi

        PRIMARY_SLUG="$(echo "${PRIMARY_FILE}" | tr '/\\' '_' | tr -cd '[:alnum:]_.-')"
        PRIMARY_SLUG="${PRIMARY_SLUG:0:60}"

        ARTIFACT_TAG="artifact-${BRANCH_NAME}-${PRIMARY_SLUG}-${SHA7}-${TS}"

        echo "ARTIFACT_TAG=${ARTIFACT_TAG}" >> "$GITHUB_ENV"
        echo "PRIMARY_FILE=${PRIMARY_FILE}" >> "$GITHUB_ENV"

        {
          echo "### Build Context"
          echo "- Branch: ${BRANCH_NAME}"
          echo "- Commit: ${GITHUB_SHA}"
          echo "- Primary changed file: ${PRIMARY_FILE}"
          echo "- Artifact tag: ${ARTIFACT_TAG}"
        } >> "$GITHUB_STEP_SUMMARY"
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.13.0'
        check-latest: true
        cache: 'npm'

    - name: Verify Node Version
      run: |
        node -v
        npm -v
        
    - name: Install Dependencies
      run: npm ci
      
    - name: Build Web Assets
      run: npm run build:web
      env:
        VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL || secrets.VITE_API_BASE_URL || 'http://8.130.69.127:3001' }}
      
    - name: Sync Capacitor iOS
      run: |
        npx cap --version
        npx cap sync ios

    - name: Cache CocoaPods
      uses: actions/cache@v4
      with:
        path: |
          ios/App/Pods
          ~/Library/Caches/CocoaPods
        key: ${{ runner.os }}-pods-${{ hashFiles('ios/App/Podfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-pods-

    - name: Install Pods
      working-directory: ios/App
      run: |
        rm -rf CapApp-SPM
        pod install
        
    - name: Disable Pods Manifest Check
      run: |
        cd ios/App
        # Patch project.pbxproj to disable the Manifest.lock check script
        # This script often fails in CI due to path issues (PODS_PODFILE_DIR_PATH being empty)
        ruby -e '
          path = "App.xcodeproj/project.pbxproj"
          if File.exist?(path)
            puts "Patching #{path} to disable Manifest check..."
            content = File.read(path)
            # The pattern matches the standard CocoaPods check script
            # We replace the diff command and the rest of the line with "exit 0";
            # We MUST include the closing quote and semicolon because the greedy match consumes them!
            updated = content.gsub(/diff .*Podfile\.lock.*Manifest\.lock.*/, "exit 0\";")
            File.write(path, updated)
            puts "Patch applied."
          else
            puts "Error: #{path} not found!"
            exit 1
          end
        '

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest-stable'
        
    - name: Generate Missing Icons
      run: |
        cd ios/App/App/Assets.xcassets/AppIcon.appiconset
        
        # Overwrite Contents.json with a clean, correct definition
        cat > Contents.json <<EOF
        {
          "images" : [
            { "size" : "20x20", "idiom" : "iphone", "filename" : "AppIcon-20x20@2x.png", "scale" : "2x" },
            { "size" : "20x20", "idiom" : "iphone", "filename" : "AppIcon-20x20@3x.png", "scale" : "3x" },
            { "size" : "29x29", "idiom" : "iphone", "filename" : "AppIcon-29x29@2x.png", "scale" : "2x" },
            { "size" : "29x29", "idiom" : "iphone", "filename" : "AppIcon-29x29@3x.png", "scale" : "3x" },
            { "size" : "40x40", "idiom" : "iphone", "filename" : "AppIcon-40x40@2x.png", "scale" : "2x" },
            { "size" : "40x40", "idiom" : "iphone", "filename" : "AppIcon-40x40@3x.png", "scale" : "3x" },
            { "size" : "60x60", "idiom" : "iphone", "filename" : "AppIcon-60x60@2x.png", "scale" : "2x" },
            { "size" : "60x60", "idiom" : "iphone", "filename" : "AppIcon-60x60@3x.png", "scale" : "3x" },
            { "size" : "20x20", "idiom" : "ipad", "filename" : "AppIcon-20x20@1x.png", "scale" : "1x" },
            { "size" : "20x20", "idiom" : "ipad", "filename" : "AppIcon-20x20@2x.png", "scale" : "2x" },
            { "size" : "29x29", "idiom" : "ipad", "filename" : "AppIcon-29x29@1x.png", "scale" : "1x" },
            { "size" : "29x29", "idiom" : "ipad", "filename" : "AppIcon-29x29@2x.png", "scale" : "2x" },
            { "size" : "40x40", "idiom" : "ipad", "filename" : "AppIcon-40x40@1x.png", "scale" : "1x" },
            { "size" : "40x40", "idiom" : "ipad", "filename" : "AppIcon-40x40@2x.png", "scale" : "2x" },
            { "size" : "76x76", "idiom" : "ipad", "filename" : "AppIcon-76x76@1x.png", "scale" : "1x" },
            { "size" : "76x76", "idiom" : "ipad", "filename" : "AppIcon-76x76@2x.png", "scale" : "2x" },
            { "size" : "83.5x83.5", "idiom" : "ipad", "filename" : "AppIcon-83.5x83.5@2x.png", "scale" : "2x" },
            { "size" : "1024x1024", "idiom" : "ios-marketing", "filename" : "AppIcon-1024x1024.png", "scale" : "1x" }
          ],
          "info" : { "version" : 1, "author" : "xcode" }
        }
        EOF
        
        SOURCE_ICON="AppIcon-512@2x.png"
        if [ ! -f "$SOURCE_ICON" ]; then
          echo "Missing source icon: $SOURCE_ICON"
          ls -la
          exit 1
        fi

        generate_icon() {
          local filename="$1"
          local size="$2"
          sips -z "$size" "$size" "$SOURCE_ICON" --out "$filename" >/dev/null
        }

        generate_icon "AppIcon-20x20@1x.png" 20
        generate_icon "AppIcon-20x20@2x.png" 40
        generate_icon "AppIcon-20x20@3x.png" 60
        generate_icon "AppIcon-29x29@1x.png" 29
        generate_icon "AppIcon-29x29@2x.png" 58
        generate_icon "AppIcon-29x29@3x.png" 87
        generate_icon "AppIcon-40x40@1x.png" 40
        generate_icon "AppIcon-40x40@2x.png" 80
        generate_icon "AppIcon-40x40@3x.png" 120
        generate_icon "AppIcon-60x60@2x.png" 120
        generate_icon "AppIcon-60x60@3x.png" 180
        generate_icon "AppIcon-76x76@1x.png" 76
        generate_icon "AppIcon-76x76@2x.png" 152
        generate_icon "AppIcon-83.5x83.5@2x.png" 167
        generate_icon "AppIcon-1024x1024.png" 1024
        
    - name: Remove Development Team
      run: |
        cd ios/App
        sed -i '' 's/DEVELOPMENT_TEAM = .*/DEVELOPMENT_TEAM = "";/g' App.xcodeproj/project.pbxproj
        
    - name: Build for Simulator (Debug)
      run: |
        cd ios/App
        rm -rf build/DerivedData
        
        if [ ! -d "App.xcworkspace" ]; then
          echo "Error: Workspace not found! CocoaPods install failed."
          # Debug: list what IS here
          ls -R .
          exit 1
        fi
        
        set -o pipefail
        xcodebuild -workspace App.xcworkspace \
          -scheme App \
          -configuration Debug \
          -destination 'generic/platform=iOS Simulator' \
          -derivedDataPath build/DerivedData \
          IPHONEOS_DEPLOYMENT_TARGET=15.0 \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          COMPILER_INDEX_STORE_ENABLE=NO \
          SWIFT_ENABLE_EXPLICIT_MODULES=NO \
          ENABLE_USER_SCRIPT_SANDBOXING=NO 2>&1 | tee xcodebuild.log
        exit_code=${PIPESTATUS[0]}
        if [ $exit_code -ne 0 ]; then
          grep -n "error:" xcodebuild.log | head -n 200 || true
          exit $exit_code
        fi
        
    - name: Package Simulator App
      run: |
        cd ios/App
        # Compress the .app for Simulator (Debug folder)
        cd build/DerivedData/Build/Products/Debug-iphonesimulator
        zip -r App-Simulator.zip App.app

    - name: Build for Device (Unsigned)
      run: |
        cd ios/App
        rm -rf build/DerivedDataDevice

        set -o pipefail
        xcodebuild -workspace App.xcworkspace \
          -scheme App \
          -configuration Debug \
          -sdk iphoneos \
          -destination 'generic/platform=iOS' \
          -derivedDataPath build/DerivedDataDevice \
          IPHONEOS_DEPLOYMENT_TARGET=15.0 \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          COMPILER_INDEX_STORE_ENABLE=NO \
          SWIFT_ENABLE_EXPLICIT_MODULES=NO \
          ENABLE_USER_SCRIPT_SANDBOXING=NO 2>&1 | tee xcodebuild-device.log
        exit_code=${PIPESTATUS[0]}
        if [ $exit_code -ne 0 ]; then
          grep -n "error:" xcodebuild-device.log | head -n 200 || true
          exit $exit_code
        fi

        APP_PATH="build/DerivedDataDevice/Build/Products/Debug-iphoneos/App.app"
        if [ ! -d "${APP_PATH}" ]; then
          echo "Error: Device .app not found at ${APP_PATH}"
          find build/DerivedDataDevice/Build/Products -maxdepth 4 -type d -name '*.app' -print || true
          exit 1
        fi

        rm -rf build/Payload
        mkdir -p build/Payload
        cp -R "${APP_PATH}" build/Payload/
        cd build
        zip -r App-Unsigned.ipa Payload
        
    - name: Upload Simulator App
      uses: actions/upload-artifact@v4
      with:
        name: app-simulator-${{ env.ARTIFACT_TAG }}
        path: ios/App/build/DerivedData/Build/Products/Debug-iphonesimulator/App-Simulator.zip

    - name: Upload Unsigned Device IPA
      uses: actions/upload-artifact@v4
      with:
        name: app-unsigned-ipa-${{ env.ARTIFACT_TAG }}
        path: ios/App/build/App-Unsigned.ipa

    - name: Upload Xcode Build Log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ios-xcodebuild-log-${{ env.ARTIFACT_TAG }}
        path: ios/App/xcodebuild.log

    - name: Upload Device Build Log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ios-xcodebuild-device-log-${{ env.ARTIFACT_TAG }}
        path: ios/App/xcodebuild-device.log
