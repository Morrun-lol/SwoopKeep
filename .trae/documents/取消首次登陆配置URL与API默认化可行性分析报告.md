# 取消首次登录配置 URL / API 的默认化可行性分析报告

## 1. 现状与痛点

当前 App 在“首次使用/首次登录”时，需要用户手动配置 `AI API Base URL / Supabase` 等关键后端地址。

主要痛点：
- 新用户无法判断应填什么地址，错误率高，导致“API 连接失败 / Load failed”。
- 手机端/弱网环境下，配置错误会直接阻断核心功能（语音识别、语义解析、上传小票）。
- 配置分散在客户端，排查成本高，难以形成可复现的线上支持流程。

## 2. 目标方案（默认配置后台化）

目标：将“必须由用户手动填写的后端 URL/API”改为“应用内置默认配置 + 可选覆盖”，做到开箱即用。

推荐的配置策略：
- **默认配置（内置）**：App 内置一套默认 `API Base URL` 和 Supabase 连接信息（至少包含 `apiBaseUrl`）。
- **可选覆盖（高级设置）**：保留设置入口允许高级用户覆盖默认值（便于自部署/灰度环境）。
- **动态配置（可选增强）**：App 启动时先请求一个轻量配置文件（如 `https://config.example.com/app.json`），可按地区/版本下发。

## 3. 技术实现路径

### 3.1 客户端配置优先级

建议统一为：
1) 用户在设置页保存的运行时配置（`runtimeConfig`）
2) 内置默认配置（按地区/渠道）
3) 环境变量（开发/测试用）

这样可以避免“首次必须配置”，同时保留可调试性。

### 3.2 配置托管/下发

两种模式：
- **静态托管**：将 `app-config.json` 放在国内可访问的 CDN/对象存储；App 启动时拉取，失败则回落到内置默认值。
- **API 下发**：由你自建 API 提供 `/config`，返回 region、可用 provider、基础 URL 列表等。

### 3.3 版本兼容与灰度

- 配置应包含 `minSupportedAppVersion`，防止旧客户端拿到不兼容参数。
- 可按 `channel`（App Store/TestFlight/企业签）下发不同默认值。

## 4. 安全性考量

### 4.1 不应默认下发/内置的内容

- 任何 **密钥类信息**（OpenAI/DeepSeek/Supabase service_role_key）绝对不能内置或下发。
- Supabase 的 `anon_key` 可以内置，但要配合严格 RLS 与限权策略。

### 4.2 配置完整性与防篡改

- 动态配置建议使用签名校验（例如配置 JSON 携带 `signature`，客户端用公钥验签）。
- 对关键字段做白名单校验（仅允许 https、域名列表等）。

## 5. 对现有用户与数据迁移影响

- 对已配置用户：保持当前设置优先级最高，不破坏历史配置。
- 对未配置用户：自动启用默认值；首次进入语音/上传页即可工作。
- 对错误配置用户：提供“一键恢复默认配置”。

## 6. 预期体验提升与度量

可量化指标：
- 首次使用成功率（首次进入语音页成功解析/保存的比例）提升。
- 支持工单中“不会配置 URL/一直报 Load failed”类问题显著下降。
- 新用户从安装到完成第一笔记账的时间缩短。

## 7. 实施建议（落地步骤）

1) 在客户端引入“默认配置优先级”逻辑，并提供“恢复默认配置”按钮。
2) 对 `/api/ai/health` 做更友好的诊断输出（区分：服务不可达 / Key 未配置 / 模型不可用）。
3) 选择一套中国大陆可稳定访问的默认 AI provider 组合（建议以 DeepSeek 为主，OpenAI 作为可选）。
4) 如需要动态配置：上线配置托管与签名校验，再做按版本/地区灰度。

