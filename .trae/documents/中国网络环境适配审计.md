# 中国网络环境适配审计

## 1. 目标

保证 App 在中国大陆常见网络（电信/移动/联通，4G/5G/宽带）下：
- 核心功能可用：语音记账、语义解析、历史数据上传、账单浏览/筛选
- 不因境外域名不可达导致页面功能阻塞
- 诊断信息明确，可引导用户自救

## 2. 发现的潜在风险点（代码级）

### 2.1 语音/语义相关

- Web/手机模式语音转写接口 `/api/ai/transcribe` 强依赖 `OPENAI_API_KEY`（OpenAI 可能在国内不可达或不稳定）。
- 语义解析 `/api/ai/parse-expense` 优先 DeepSeek，其次 OpenAI；若都没配会直接失败。

### 2.2 OCR（小票识别）

- Electron 本地 OCR 使用 `tesseract.js`，配置了外部 `langPath` 下载训练数据，若网络受限可能首次下载失败。
- Web/手机模式 `/api/ai/recognize-image` 目前依赖 OpenAI Vision（国内不可用时会失败）。

### 2.3 网络诊断

- 诊断包含 Google 探测，在国内经常失败，但它不应作为“核心功能可用性”的判断依据。

## 3. 已落地的改进

- 网络诊断日志增加 `AI API Base URL` 输出，便于直接判断是否填错/不可达。
- 语音语义解析前增加基础文本归一化，减少噪声导致的解析失败。

## 4. 建议的适配策略（推荐优先级）

### 4.1 AI Provider 策略

- 默认推荐 DeepSeek（国内可用性更高），OpenAI 作为可选。
- 将“Key 未配置/不可达”从“接口失败”中明确区分出来，给出可执行提示（改用模拟测试/手动输入）。

### 4.2 OCR 策略

- 桌面端：优先本地 OCR（tesseract），并支持用户预置训练数据目录（避免首次下载依赖外网）。
- 手机端：优先使用系统能力（拍照后先做本地文字识别）或接入国内可用的 OCR 服务。

### 4.3 上传/下载

- Excel 导入采用批量写入与断点续传（已实现/增强），避免弱网下长时间阻塞。
- 重试策略保持指数退避 + jitter，减少在抖动网络下的雪崩。

## 5. 测试用例（建议）

- 中国移动/联通/电信：分别在 4G/5G/家庭宽带下跑一次：
  - 网络诊断（应能输出 baseUrl 与 health 状态）
  - 语音：模拟测试→解析→保存
  - 上传：导入 1k 行 Excel，观察速度/失败重试/断点续传
- 弱网/丢包：开启网络限速或切换网络，确认导入与语义解析错误提示可理解。

